<!DOCTYPE HTML>
<html>
  <head>
    <title>DIFF | <%= title.jp %></title>
    <%- include('layout/common_head.ejs.html') -%>

  <!--
  //////////////////////////////////////////////////////

  FREE HTML5 TEMPLATE
  DESIGNED & DEVELOPED by FreeHTML5.co

  Website:    http://freehtml5.co/
  Email:      info@freehtml5.co
  Twitter:    http://twitter.com/fh5co
  Facebook:     https://www.facebook.com/fh5co

  //////////////////////////////////////////////////////
   -->

    <!-- <link href="https://fonts.googleapis.com/css?family=Work+Sans:300,400,500,700,800" rel="stylesheet">  -->
    <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet">

    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="js/respond.min.js"></script>
    <![endif]-->

  </head>
  <body>

  <div class="fh5co-loader"></div>

  <div id="page">
<!-- Header -->
  <%- include('layout/header.ejs.html') -%>

  <div class="fh5co-contact">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <textarea class="form-control" rows="10" id="txt1" name="txt1" placeholder="テキストをはりつけて！ or ファイルをドロップして！"></textarea>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <textarea class="form-control" rows="10" id="txt2" name="txt2" placeholder="テキストをはりつけて！ or ファイルをドロップして！"></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-12">
          <div class="form-group row">
            <label for="optradio" class="col-sm-2 col-form-label">表示方式</label>
            <div class="col-sm-10">
              <label class="radio-inline"><input type="radio" name="optradio" value="side-by-side" checked>Side by Side</label>
              <label class="radio-inline"><input type="radio" name="optradio" value="line-by-line">Line by Line</label>
            </div>
          </div>
          <div class="form-group row">
            <section>
              <label class="col-form-label" data-toggle="collapse" data-target="#options" style="padding-left: 15px;">オプション ▼</label>
              <div id="options" class="collapse">
                <div class="panel panel-default">
                  <div class="panel-body">

                    <div class="form-group row">
                      <label for="sort" class="col-sm-2 col-form-label">ソート</label>
                      <div class="col-sm-10">
                        <label class="radio-inline"><input type="radio" name="sort" value="none" checked>しない</label>
                        <label class="radio-inline"><input type="radio" name="sort" value="do">する</label>
                      </div>
                    </div>

                    <div class="form-group row">
                      <label for="sort" class="col-sm-2 col-form-label">最終改行の差分</label>
                      <div class="col-sm-10">
                        <label class="radio-inline"><input type="radio" name="last_line" value="noignore">無視しない</label>
                        <label class="radio-inline"><input type="radio" name="last_line" value="ignore" checked>無視する</label>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </section>
          </div>

          <div class="form-group row">
            <a href="#app">
              <button type="button" id="btn-exec" class="btn btn-primary">比較する</button>
            </a>
            <button type="button" id="btn-reset" class="btn btn-danger">リセット</button>
            <a href="#" id="btn-download" class="btn btn-default">ダウンロード</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  </div>

  <div>
    <div id="app" name="app">
    </div>
  </div>

<!-- Footer -->
  <%- include('layout/footer.ejs.html') -%>

  <div class="gototop js-top">
    <a href="#" class="js-gotop"><i class="icon-arrow-up22"></i></a>
  </div>

<!-- Scripts -->
  <%- include('layout/script.ejs.html') -%>

  <script>

  document.addEventListener('DOMContentLoaded', function() {
    $("#btn-download").prop("disabled", true);

    (function() {
      var droppable = $("body");

      // File API が使用できない場合は諦めます.
      if(!window.FileReader) {
        alert("File API がサポートされていません。");
        return false;
      }

      // イベントをキャンセルするハンドラです.
      var cancelEvent = function(event) {
          event.preventDefault();
          event.stopPropagation();
          return false;
      }

      // dragenter, dragover イベントのデフォルト処理をキャンセルします.
      droppable.bind("dragenter", cancelEvent);
      droppable.bind("dragover", cancelEvent);

      // ドロップ時のイベントハンドラを設定します.
      var handleDroppedFile = function(event) {
        var fileCount = event.originalEvent.dataTransfer.files.length;

        if(fileCount == 1) {
          var file = event.originalEvent.dataTransfer.files[0];

          var fileReader = new FileReader();
          fileReader.onload = function(event) {
            $('#txt1').val(event.target.result);
          }
          fileReader.readAsText(file);
        } else if(fileCount == 2) {
          var file1 = event.originalEvent.dataTransfer.files[0];
          var file2 = event.originalEvent.dataTransfer.files[1];

          var fileReader = new FileReader();

          var targetTxt = '#txt1';
          fileReader.onload = function(event) {
            $(targetTxt).val(event.target.result);

            // 回帰的に呼び出しているのは、１回目のreadAsTextが終わらない内に次の、readAsTextを実行するとエラーが発生するため。
            if(targetTxt == '#txt1'){
              targetTxt = '#txt2';
              fileReader.readAsText(file2);
            }
            if(targetTxt == '#txt2'){
              $('#btn-exec').click();
            }
          }

          fileReader.readAsText(file1);
        } else if(fileCount > 2) {
          alert('ファイルは2個までドロップ可能です。');
        }

        // デフォルトの処理をキャンセルします.
        cancelEvent(event);
        return false;
      }

      // ドロップ時のイベントハンドラを設定します.
      droppable.bind("drop", handleDroppedFile);
    })();

    $('#btn-exec').on('click', function(){
      var text1 = $('#txt1').val().replace(/\r?\n/g, "\n");
      var text2 = $('#txt2').val().replace(/\r?\n/g, "\n");
      const outputFormat = $('input[name=optradio]:checked').val();
      const sort = $('input[name=sort]:checked').val();
      if(sort == 'do') {
        text1 = text1.split("\n").sort().join("\n");
        text2 = text2.split("\n").sort().join("\n");
      }
      const lastLineState = $('input[name=last_line]:checked').val();
     if(lastLineState == 'ignore') {
        text1 = text1.replace(/\s+$/, '');
        text2 = text2.replace(/\s+$/, '');
      }

      const unifiedDiff = JsDiff.createPatch("fileName", text1, text2, "test", "test");

      var actionHasDiff = function(unifiedDiff) {
        $('#app').html('');

        const diff2htmlUi = new Diff2HtmlUI({diff: unifiedDiff});
        diff2htmlUi.draw('#app', {inputFormat: 'json', showFiles: true, matching: 'lines', outputFormat: outputFormat});
        $('.d2h-file-list-wrapper').css('display', 'none');
        $('.d2h-file-header').css('display', 'none');

        // contextに変更
        $('.d2h-diff-tbody .d2h-code-line-prefix').each(function(index, element){
          if($(element).text() == '+') {
            $(element).addClass('plus');
          } else if($(element).text() == '-') {
            $(element).addClass('minus');
          } else {
            $(element).addClass('space');
          }

          $(element).text(' ');
        });

        // ダウンロードボタンの有効化
        $('#btn-download').removeClass('btn-default');
        $('#btn-download').addClass('btn-primary');
        $("#btn-download").prop("disabled", false);
      }

      // 差分の有無
      if(unifiedDiff.indexOf('@') > -1) {
        $(".fh5co-loader").fadeIn("slow");

        actionHasDiff(unifiedDiff);

        $(".fh5co-loader").fadeOut("slow");
      } else {
        $('#btn-download').removeClass('btn-primary');
        $('#btn-download').addClass('btn-default');
        $("#btn-download").prop("disabled", true);

        var html = '';
        html += '<div class="container">';
        html += '  <div class="row">';
        html += '    <div class="col-md-8 col-md-offset-2 text-center fh5co-heading">';
        html += '      <h2 style="color: #d9534f">差分はありません</h2>';
        html += '    </div>';
        html += '  </div>';
        html += '</div>';
        $('#app').html(html);
      }

    });

    // ファイルとしてダウンロード
    // https://ja.stackoverflow.com/questions/300/javascript%E3%81%8B%E3%82%89%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E3%81%95%E3%81%9B%E3%82%8B%E3%81%AE%E3%81%AF%E3%81%A9%E3%81%86%E3%81%97%E3%81%9F%E3%82%89%E8%89%AF%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B
    var downloadAsFile = function(fileName, content) {
        var blob = new Blob([content]);
        var url = window.URL || window.webkitURL;
        var blobURL = url.createObjectURL(blob);

        var a = document.createElement('a');
        a.download = fileName;
        a.href = blobURL;
        a.click();
    };

    /* ダウンロード処理 */
    $('#btn-download').on('click', function(){
      // ボタンが無効でないか
      if($("#btn-download").prop('disabled')) { return; }

      var html = '';
      html += '<html>';
      html += '  </head>';
      html += '    <style>';
      // HACKME: 直書き以外に良い方法があれば変更
      // diff2html.min.scss を書き出し
      html += '      .d2h-wrapper{text-align:left}.d2h-file-header{padding:5px 10px;border-bottom:1px solid #d8d8d8;background-color:#f7f7f7}.d2h-file-stats{display:-webkit-box;display:-ms-flexbox;display:flex;margin-left:auto;font-size:14px}.d2h-lines-added{text-align:right;border:1px solid #b4e2b4;border-radius:5px 0 0 5px;color:#399839;padding:2px;vertical-align:middle}.d2h-lines-deleted{text-align:left;border:1px solid #e9aeae;border-radius:0 5px 5px 0;color:#c33;padding:2px;vertical-align:middle;margin-left:1px}.d2h-file-name-wrapper{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:100%;font-family:"Source Sans Pro","Helvetica Neue",Helvetica,Arial,sans-serif;font-size:15px}.d2h-file-name{white-space:nowrap;text-overflow:ellipsis;overflow-x:hidden;line-height:21px}.d2h-file-wrapper{border:1px solid #ddd;border-radius:3px;margin-bottom:1em}.d2h-diff-table{width:100%;border-collapse:collapse;font-family:Menlo,Consolas,monospace;font-size:13px}.d2h-diff-tbody>tr>td{height:20px;line-height:20px}.d2h-files-diff{display:block;width:100%;height:100%}.d2h-file-diff{overflow-x:scroll;overflow-y:hidden}.d2h-file-side-diff{display:inline-block;overflow-x:scroll;overflow-y:hidden;width:50%;margin-right:-4px;margin-bottom:-8px}.d2h-code-line{display:inline-block;white-space:nowrap;padding:0 10px;margin-left:80px}.d2h-code-side-line{display:inline-block;white-space:nowrap;padding:0 10px;margin-left:50px}.d2h-code-line del,.d2h-code-side-line del{display:inline-block;margin-top:-1px;text-decoration:none;background-color:#ffb6ba;border-radius:.2em}.d2h-code-line ins,.d2h-code-side-line ins{display:inline-block;margin-top:-1px;text-decoration:none;background-color:#97f295;border-radius:.2em;text-align:left}.d2h-code-line-prefix{display:inline;background:0 0;padding:0;word-wrap:normal;white-space:pre}.d2h-code-line-ctn{display:inline;background:0 0;padding:0;word-wrap:normal;white-space:pre}.line-num1{-webkit-box-sizing:border-box;box-sizing:border-box;float:left;width:40px;overflow:hidden;text-overflow:ellipsis;padding-left:3px}.line-num2{-webkit-box-sizing:border-box;box-sizing:border-box;float:right;width:40px;overflow:hidden;text-overflow:ellipsis;padding-left:3px}.d2h-code-linenumber{-webkit-box-sizing:border-box;box-sizing:border-box;position:absolute;width:86px;padding-left:2px;padding-right:2px;background-color:#fff;color:rgba(0,0,0,.3);text-align:right;border:solid #eee;border-width:0 1px 0 1px;cursor:pointer}.d2h-code-side-linenumber{-webkit-box-sizing:border-box;box-sizing:border-box;position:absolute;width:56px;padding-left:5px;padding-right:5px;background-color:#fff;color:rgba(0,0,0,.3);text-align:right;border:solid #eee;border-width:0 1px 0 1px;cursor:pointer;overflow:hidden;text-overflow:ellipsis}.d2h-del{background-color:#fee8e9;border-color:#e9aeae}.d2h-ins{background-color:#dfd;border-color:#b4e2b4}.d2h-info{background-color:#f8fafd;color:rgba(0,0,0,.3);border-color:#d5e4f2}.d2h-file-diff .d2h-del.d2h-change{background-color:#fdf2d0}.d2h-file-diff .d2h-ins.d2h-change{background-color:#ded}.d2h-file-list-wrapper{margin-bottom:10px}.d2h-file-list-wrapper a{text-decoration:none;color:#3572b0}.d2h-file-list-wrapper a:visited{color:#3572b0}.d2h-file-list-header{text-align:left}.d2h-file-list-title{font-weight:700}.d2h-file-list-line{display:-webkit-box;display:-ms-flexbox;display:flex;text-align:left}.d2h-file-list{display:block;list-style:none;padding:0;margin:0}.d2h-file-list>li{border-bottom:#ddd solid 1px;padding:5px 10px;margin:0}.d2h-file-list>li:last-child{border-bottom:none}.d2h-file-switch{display:none;font-size:10px;cursor:pointer}.d2h-icon-wrapper{line-height:31px}.d2h-icon{vertical-align:middle;margin-right:10px;fill:currentColor}.d2h-deleted{color:#c33}.d2h-added{color:#399839}.d2h-changed{color:#d0b44c}.d2h-moved{color:#3572b0}.d2h-tag{display:-webkit-box;display:-ms-flexbox;display:flex;font-size:10px;margin-left:5px;padding:0 2px;background-color:#fff}.d2h-deleted-tag{border:#c33 1px solid}.d2h-added-tag{border:#399839 1px solid}.d2h-changed-tag{border:#d0b44c 1px solid}.d2h-moved-tag{border:#3572b0 1px solid}.selecting-left .d2h-code-line,.selecting-left .d2h-code-line *,.selecting-left .d2h-code-side-line,.selecting-left .d2h-code-side-line *,.selecting-right td.d2h-code-linenumber,.selecting-right td.d2h-code-linenumber *,.selecting-right td.d2h-code-side-linenumber,.selecting-right td.d2h-code-side-linenumber *{-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.selecting-left .d2h-code-line ::-moz-selection,.selecting-left .d2h-code-line::-moz-selection,.selecting-left .d2h-code-side-line ::-moz-selection,.selecting-left .d2h-code-side-line::-moz-selection,.selecting-right td.d2h-code-linenumber::-moz-selection,.selecting-right td.d2h-code-side-linenumber ::-moz-selection,.selecting-right td.d2h-code-side-linenumber::-moz-selection{background:0 0}.selecting-left .d2h-code-line ::selection,.selecting-left .d2h-code-line::selection,.selecting-left .d2h-code-side-line ::selection,.selecting-left .d2h-code-side-line::selection,.selecting-right td.d2h-code-linenumber::selection,.selecting-right td.d2h-code-side-linenumber ::selection,.selecting-right td.d2h-code-side-linenumber::selection{background:0 0}';
      // 結果部分のCSSを修正した場合、こっちも修正する必要がある。
      html += '      .d2h-diff-tbody .d2h-code-line-prefix.plus:before {content: "+";}.d2h-diff-tbody .d2h-code-line-prefix.minus:before {content: "-";}';
      html += '    </style>';
      html += '  </head>';
      html += '  <body>';
      html += '    <a href="<%= url %>" target="_blank" style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: #000; text-decoration: none; font-family: "Inconsolata", Arial, sans-serif;"><h1><%= title.en %>.</h1></a>';
      html += '    ' + document.getElementById("app").innerHTML;
      html += '  </body>';
      html += '</html>';

      downloadAsFile('diff_result.html', html);
    });

    /* リセット処理 */
    $('#btn-reset').on('click', function(){
      $('#txt1').val('');
      $('#txt2').val('');
    });

  });
  </script>

  </body>
</html>